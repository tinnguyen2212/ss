<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch Âm Dương Việt Nam</title>
    <style>
        :root {
            --primary-color: #e74c3c;
            --secondary-color: #c0392b;
            --text-dark: #333;
            --text-light: #fff;
            --background-light: #f8f8f8;
            --background-pink: #fadadd;
            --border-color: #ddd;
            --gray-light: #eee;
            --gray-medium: #ccc;
            --danger-color: #c0392b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background-color: var(--background-light);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        /* Lịch ngày */
        .today-calendar {
            flex: 1;
            min-width: 300px;
            background-color: var(--background-pink);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 10px;
        }

        .month-nav button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.2rem;
            cursor: pointer;
        }

        .month-title {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
        }

        .date-display {
            text-align: center;
            padding: 20px 0;
        }

        .date-number {
            font-size: 5rem;
            font-weight: bold;
            color: var(--primary-color);
            line-height: 1;
        }

        .weekday {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 5px 0;
        }

        /* Thông tin lịch âm */
        .lunar-info {
            display: flex;
            justify-content: space-between;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }

        .lunar-date {
            text-align: left;
            font-size: 1.2rem;
            color: #8b0000;
        }

        .lunar-day {
            font-size: 2rem;
            font-weight: bold;
        }

        .lunar-month {
            font-weight: bold;
        }

        .lunar-year {
            margin-top: 5px;
        }

        .lunar-details {
            text-align: right;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .detail-label {
            font-weight: bold;
            margin-right: 10px;
        }

        .time-now {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 10px;
        }

        .sat-su-info {
            text-align: center;
            padding: 10px;
            font-size: 1rem;
            color: var(--danger-color);
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.7);
            border-top: 1px solid var(--border-color);
        }

        /* Lịch tháng */
        .month-calendar {
            flex: 1;
            min-width: 300px;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .month-header {
            background-color: var(--primary-color);
            color: var(--text-light);
            text-align: center;
            padding: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .month-header button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-header {
            background-color: var(--gray-light);
            font-weight: bold;
            text-align: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .calendar-day {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            min-height: 70px;
            position: relative;
        }

        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-day.today {
            background-color: var(--background-pink);
        }

        .calendar-day.different-month {
            color: var(--gray-medium);
        }

        .solar-day {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .lunar-day-small {
            font-size: 0.8rem;
            color: #8b0000;
        }

        .sat-su-day {
            position: relative;
        }

        .sat-su-day::after {
            content: "•";
            position: absolute;
            top: 0;
            right: 5px;
            color: var(--danger-color);
            font-size: 1.2rem;
        }

        /* Phần chuyển đổi lịch */
        .converter {
            flex: 100%;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .converter h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .converter-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .converter-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .converter-buttons button {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            flex: 1;
        }

        .converter-buttons button:hover {
            background-color: var(--secondary-color);
        }

        .converter-result {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--gray-light);
            border-radius: 4px;
            display: none;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
        }

        .tab-button {
            padding: 10px 20px;
            background-color: var(--gray-light);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            margin-right: 5px;
        }

        .tab-button.active {
            background-color: white;
            border-bottom: 2px solid white;
            position: relative;
            z-index: 1;
            font-weight: bold;
        }

        .tab-content {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 0 4px 4px 4px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .navigation button {
            padding: 8px 15px;
            background-color: var(--gray-light);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Lịch ngày -->
        <div class="today-calendar">
            <div class="month-nav">
                <button id="prev-day">&lt;</button>
                <div class="month-title" id="solar-month-year">THÁNG 3 NĂM 2025</div>
                <button id="next-day">&gt;</button>
            </div>
            <div class="date-display">
                <div class="date-number" id="current-date">21</div>
                <div class="weekday" id="weekday">THỨ SÁU</div>
            </div>
            <div class="lunar-info">
                <div class="lunar-date">
                    <div class="lunar-day" id="lunar-day">22</div>
                    <div class="lunar-month" id="lunar-month">THÁNG HAI</div>
                    <div class="lunar-year" id="lunar-year">Năm Ất Tỵ</div>
                </div>
                <div class="lunar-details">
                    <div class="detail-row">
                        <span class="detail-label">Ngày:</span>
                        <span id="can-chi-day">Kỷ Sửu</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Tháng:</span>
                        <span id="can-chi-month">Kỷ Mão</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Năm:</span>
                        <span id="can-chi-year">Ất Tỵ</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Tiết khí:</span>
                        <span id="tiet-khi">Xuân phân</span>
                    </div>
                </div>
            </div>
            <div class="time-now" id="current-time">09:57:25</div>
            <div class="sat-su-info" id="sat-su-info">Ngày Sát Sư (Mão), Giờ Sát Sư (Ngọ)</div>
            <div class="navigation">
                <button id="yesterday">Hôm qua</button>
                <button id="today-button">Hôm nay</button>
                <button id="tomorrow">Ngày mai</button>
            </div>
        </div>

        <!-- Lịch tháng -->
        <div class="month-calendar">
            <div class="month-header">
                <button id="prev-month">&lt;</button>
                <span id="month-title">LỊCH ÂM THÁNG 3/2025</span>
                <button id="next-month">&gt;</button>
            </div>
            <div class="calendar-grid" id="calendar-headers">
                <div class="calendar-header">T2</div>
                <div class="calendar-header">T3</div>
                <div class="calendar-header">T4</div>
                <div class="calendar-header">T5</div>
                <div class="calendar-header">T6</div>
                <div class="calendar-header">T7</div>
                <div class="calendar-header">CN</div>
            </div>
            <div class="calendar-grid" id="calendar-days">
                <!-- Calendar days will be inserted here by JS -->
            </div>
        </div>

        <!-- Phần chuyển đổi lịch -->
        <div class="converter">
            <h2>Chuyển đổi lịch Âm - Dương</h2>
            <div class="tab-buttons">
                <button class="tab-button active" id="solar-to-lunar-tab">Dương lịch sang Âm lịch</button>
                <button class="tab-button" id="lunar-to-solar-tab">Âm lịch sang Dương lịch</button>
            </div>
            <div class="tab-content active" id="solar-to-lunar-content">
                <div class="converter-form">
                    <div class="form-group">
                        <label for="solar-day">Ngày:</label>
                        <input type="number" id="solar-day" min="1" max="31" value="21">
                    </div>
                    <div class="form-group">
                        <label for="solar-month">Tháng:</label>
                        <input type="number" id="solar-month" min="1" max="12" value="3">
                    </div>
                    <div class="form-group">
                        <label for="solar-year">Năm:</label>
                        <input type="number" id="solar-year" min="1900" max="2100" value="2025">
                    </div>
                </div>
                <div class="converter-buttons">
                    <button id="convert-to-lunar">Chuyển đổi sang Âm lịch</button>
                </div>
            </div>
            <div class="tab-content" id="lunar-to-solar-content">
                <div class="converter-form">
                    <div class="form-group">
                        <label for="lunar-day">Ngày:</label>
                        <input type="number" id="lunar-day" min="1" max="30" value="1">
                    </div>
                    <div class="form-group">
                        <label for="lunar-month">Tháng:</label>
                        <input type="number" id="lunar-month" min="1" max="12" value="1">
                    </div>
                    <div class="form-group">
                        <label for="lunar-year">Năm:</label>
                        <input type="number" id="lunar-year" min="1900" max="2100" value="2025">
                    </div>
                    <div class="form-group">
                        <label for="lunar-leap">Tháng nhuận:</label>
                        <select id="lunar-leap">
                            <option value="0">Không</option>
                            <option value="1">Có</option>
                        </select>
                    </div>
                </div>
                <div class="converter-buttons">
                    <button id="convert-to-solar">Chuyển đổi sang Dương lịch</button>
                </div>
            </div>
            <div class="converter-result" id="converter-result">
                <p id="result-text"></p>
            </div>
        </div>
    </div>

    <script>
        /**
         * Thuật toán âm lịch của Hồ Ngọc Đức
         * Source: https://www.informatik.uni-leipzig.de/~duc/amlich/
         */
        var PI = Math.PI;

        /* Chuyển đổi số nguyên sang số dạng chuỗi có hai chữ số */
        function getTwoDigits(num) {
            return (num < 10) ? '0' + num : '' + num;
        }

        /* Tính Julian day từ ngày/tháng/năm dương lịch */
        function jdFromDate(dd, mm, yy) {
            var a = Math.floor((14 - mm) / 12);
            var y = yy + 4800 - a;
            var m = mm + 12 * a - 3;
            var jd = dd + Math.floor((153 * m + 2) / 5) + 365 * y + Math.floor(y / 4) - Math.floor(y / 100) + Math.floor(y / 400) - 32045;
            if (jd < 2299161) {
                jd = dd + Math.floor((153 * m + 2) / 5) + 365 * y + Math.floor(y / 4) - 32083;
            }
            return jd;
        }

        /* Chuyển Julian day sang ngày/tháng/năm dương lịch */
        function jdToDate(jd) {
            var a, b, c;
            if (jd > 2299160) { // After 5/10/1582, Gregorian calendar
                a = jd + 32044;
                b = Math.floor((4 * a + 3) / 146097);
                c = a - Math.floor((b * 146097) / 4);
            } else {
                b = 0;
                c = jd + 32082;
            }
            var d = Math.floor((4 * c + 3) / 1461);
            var e = c - Math.floor((1461 * d) / 4);
            var m = Math.floor((5 * e + 2) / 153);
            var day = e - Math.floor((153 * m + 2) / 5) + 1;
            var month = m + 3 - 12 * Math.floor(m / 10);
            var year = b * 100 + d - 4800 + Math.floor(m / 10);
            return new Array(day, month, year);
        }

        /* Tính ngày sóc thứ k kể từ điểm Sóc của tháng 11 năm 1999 */
        function getNewMoonDay(k, timeZone) {
            var T, T2, T3, dr, Jd1, M, Mpr, F, C1, delta, JdNew;
            T = k / 1236.85; // Time in Julian centuries from 1900 January 0.5
            T2 = T * T;
            T3 = T2 * T;
            dr = PI / 180;
            Jd1 = 2415020.75933 + 29.53058868 * k + 0.0001178 * T2 - 0.000000155 * T3;
            Jd1 = Jd1 + 0.00033 * Math.sin((166.56 + 132.87 * T - 0.009173 * T2) * dr); // Mean new moon
            M = 359.2242 + 29.10535608 * k - 0.0000333 * T2 - 0.00000347 * T3; // Sun's mean anomaly
            Mpr = 306.0253 + 385.81691806 * k + 0.0107306 * T2 + 0.00001236 * T3; // Moon's mean anomaly
            F = 21.2964 + 390.67050646 * k - 0.0016528 * T2 - 0.00000239 * T3; // Moon's argument of latitude
            C1 = (0.1734 - 0.000393 * T) * Math.sin(M * dr) + 0.0021 * Math.sin(2 * dr * M);
            C1 = C1 - 0.4068 * Math.sin(Mpr * dr) + 0.0161 * Math.sin(dr * 2 * Mpr);
            C1 = C1 - 0.0004 * Math.sin(dr * 3 * Mpr);
            C1 = C1 + 0.0104 * Math.sin(dr * 2 * F) - 0.0051 * Math.sin(dr * (M + Mpr));
            C1 = C1 - 0.0074 * Math.sin(dr * (M - Mpr)) + 0.0004 * Math.sin(dr * (2 * F + M));
            C1 = C1 - 0.0004 * Math.sin(dr * (2 * F - M)) - 0.0006 * Math.sin(dr * (2 * F + Mpr));
            C1 = C1 + 0.0010 * Math.sin(dr * (2 * F - Mpr)) + 0.0005 * Math.sin(dr * (2 * Mpr + M));
            if (T < -11) {
                delta = 0.001 + 0.000839 * T + 0.0002261 * T2 - 0.00000845 * T3 - 0.000000081 * T * T3;
            } else {
                delta = -0.000278 + 0.000265 * T + 0.000262 * T2;
            }
            JdNew = Jd1 + C1 - delta;
            return Math.floor(JdNew + 0.5 + timeZone / 24);
        }

        /* Tính vị trí mặt trời */
        function getSunLongitude(jdn, timeZone) {
            var T, T2, dr, M, L0, DL, L;
            T = (jdn - 2451545.5 - timeZone / 24) / 36525; // Time in Julian centuries from 2000-01-01 12:00:00 GMT
            T2 = T * T;
            dr = PI / 180; // degree to radian
            M = 357.52910 + 35999.05030 * T - 0.0001559 * T2 - 0.00000048 * T * T2; // mean anomaly, degree
            L0 = 280.46645 + 36000.76983 * T + 0.0003032 * T2; // mean longitude, degree
            DL = (1.914600 - 0.004817 * T - 0.000014 * T2) * Math.sin(dr * M);
            DL = DL + (0.019993 - 0.000101 * T) * Math.sin(dr * 2 * M) + 0.000290 * Math.sin(dr * 3 * M);
            L = L0 + DL; // true longitude, degree
            // Normalize to (0, 360)
            L = L - 360 * Math.floor(L / 360);
            return Math.floor(L / 30);
        }

        /* Tìm tháng bắt đầu có chứa ngày Sóc của tháng 11 Âm lịch */
        function getLunarMonth11(yy, timeZone) {
            var k, off, nm, sunLong;
            //off = jdFromDate(31, 12, yy) - 2415021.076998695;
            off = jdFromDate(31, 12, yy) - 2415021;
            k = Math.floor(off / 29.530588853);
            nm = getNewMoonDay(k, timeZone);
            sunLong = getSunLongitude(nm, timeZone); // sun longitude at local midnight
            if (sunLong >= 9) {
                nm = getNewMoonDay(k - 1, timeZone);
            }
            return nm;
        }

        /* Xác định tháng nhuận */
        function getLeapMonthOffset(a11, timeZone) {
            var k, last, arc, i;
            k = Math.floor((a11 - 2415021.076998695) / 29.530588853 + 0.5);
            last = 0;
            i = 1; // We start with the month following lunar month 11
            arc = getSunLongitude(getNewMoonDay(k + i, timeZone), timeZone);
            do {
                last = arc;
                i++;
                arc = getSunLongitude(getNewMoonDay(k + i, timeZone), timeZone);
            } while (arc != last && i < 14);
            return i - 1;
        }

        /* Chuyển đổi dương lịch sang âm lịch */
        function convertSolar2Lunar(dd, mm, yy, timeZone) {
            var k, dayNumber, monthStart, a11, b11, lunarDay, lunarMonth, lunarYear, lunarLeap;
            dayNumber = jdFromDate(dd, mm, yy);
            k = Math.floor((dayNumber - 2415021.076998695) / 29.530588853);
            monthStart = getNewMoonDay(k + 1, timeZone);
            if (monthStart > dayNumber) {
                monthStart = getNewMoonDay(k, timeZone);
            }
            a11 = getLunarMonth11(yy, timeZone);
            b11 = a11;
            if (a11 >= monthStart) {
                lunarYear = yy;
                a11 = getLunarMonth11(yy - 1, timeZone);
            } else {
                lunarYear = yy + 1;
                b11 = getLunarMonth11(yy + 1, timeZone);
            }
            lunarDay = dayNumber - monthStart + 1;
            diff = Math.floor((monthStart - a11) / 29);
            lunarLeap = 0;
            lunarMonth = diff + 11;
            if (b11 - a11 > 365) {
                leapMonthDiff = getLeapMonthOffset(a11, timeZone);
                if (diff >= leapMonthDiff) {
                    lunarMonth = diff + 10;
                    if (diff == leapMonthDiff) {
                        lunarLeap = 1;
                    }
                }
            }
            if (lunarMonth > 12) {
                lunarMonth = lunarMonth - 12;
            }
            if (lunarMonth >= 11 && diff < 4) {
                lunarYear -= 1;
            }
            return new Array(lunarDay, lunarMonth, lunarYear, lunarLeap);
        }

        /* Chuyển đổi âm lịch sang dương lịch */
        function convertLunar2Solar(lunarDay, lunarMonth, lunarYear, lunarLeap, timeZone) {
            var k, a11, b11, off, leapOff, leapMonth, monthStart;
            if (lunarMonth < 11) {
                a11 = getLunarMonth11(lunarYear - 1, timeZone);
                b11 = getLunarMonth11(lunarYear, timeZone);
            } else {
                a11 = getLunarMonth11(lunarYear, timeZone);
                b11 = getLunarMonth11(lunarYear + 1, timeZone);
            }
            k = Math.floor(0.5 + (a11 - 2415021.076998695) / 29.530588853);
            off = lunarMonth - 11;
            if (off < 0) {
                off += 12;
            }
            if (b11 - a11 > 365) {
                leapOff = getLeapMonthOffset(a11, timeZone);
                leapMonth = leapOff - 2;
                if (leapMonth < 0) {
                    leapMonth += 12;
                }
                if (lunarLeap != 0 && lunarMonth != leapMonth) {
                    return new Array(0, 0, 0);
                } else if (lunarLeap != 0 || off >= leapOff) {
                    off += 1;
                }
            }
            monthStart = getNewMoonDay(k + off, timeZone);
            return jdToDate(monthStart + lunarDay - 1);
        }
        
        // Mảng tên tháng âm lịch
        var LUNAR_MONTH_NAMES = [
            "", "GIÊNG", "HAI", "BA", "TƯ", "NĂM", "SÁU", 
            "BẢY", "TÁM", "CHÍN", "MƯỜI", "MỘT", "CHẠP"
        ];

        /* Lấy tên tháng âm lịch */
        function getLunarMonthName(lunarMonth) {
            return "THÁNG " + LUNAR_MONTH_NAMES[lunarMonth];
        }

       /* Mảng Can Chi */
var CAN = ["Giáp", "Ất", "Bính", "Đinh", "Mậu", "Kỷ", "Canh", "Tân", "Nhâm", "Quý"];
var CHI = ["Tý", "Sửu", "Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi", "Thân", "Dậu", "Tuất", "Hợi"];
var TUAN = ["Chủ Nhật", "Thứ Hai", "Thứ Ba", "Thứ Tư", "Thứ Năm", "Thứ Sáu", "Thứ Bảy"];

/* Xác định Can Chi cho tháng âm lịch */
function getCanChiForMonth(lunarMonth, lunarYear) {
    // Công thức tính can tháng
    var canMonth = (lunarYear * 12 + lunarMonth + 3) % 10;
    
    // Tháng âm lịch và chi tương ứng
    var chiMonth;
    switch(lunarMonth) {
        case 1: chiMonth = 2; break; // Tháng Giêng - Dần
        case 2: chiMonth = 3; break; // Tháng 2 - Mão
        case 3: chiMonth = 4; break; // Tháng 3 - Thìn
        case 4: chiMonth = 5; break; // Tháng 4 - Tỵ
        case 5: chiMonth = 6; break; // Tháng 5 - Ngọ
        case 6: chiMonth = 7; break; // Tháng 6 - Mùi
        case 7: chiMonth = 8; break; // Tháng 7 - Thân
        case 8: chiMonth = 9; break; // Tháng 8 - Dậu
        case 9: chiMonth = 10; break; // Tháng 9 - Tuất
        case 10: chiMonth = 11; break; // Tháng 10 - Hợi
        case 11: chiMonth = 0; break; // Tháng 11 - Tý
        case 12: chiMonth = 1; break; // Tháng 12 - Sửu
        default: chiMonth = 0;
    }
    
    return CAN[canMonth] + " " + CHI[chiMonth];
}

/* Xác định Can Chi cho ngày, tháng, năm */
function getCanChi(dd, mm, yy) {
    var lunar = convertSolar2Lunar(dd, mm, yy, 7);
    var lunarDay = lunar[0];
    var lunarMonth = lunar[1];
    var lunarYear = lunar[2];

    var jd = jdFromDate(dd, mm, yy);
    
    // Can Chi cho ngày
    var canDay = (jd + 9) % 10;
    var chiDay = (jd + 1) % 12;
    
    // Can Chi cho năm
    var canYear = (lunarYear + 6) % 10;
    var chiYear = (lunarYear + 8) % 12;
    
    return {
        day: CAN[canDay] + " " + CHI[chiDay],
        month: getCanChiForMonth(lunarMonth, lunarYear),
        year: CAN[canYear] + " " + CHI[chiYear]
    };
}

/* Lấy chi của giờ */
function getHourChi(hour) {
    if (hour >= 23 || hour < 1) return 0;  // Tý (23-1)
    if (hour >= 1 && hour < 3) return 1;   // Sửu (1-3)
    if (hour >= 3 && hour < 5) return 2;   // Dần (3-5)
    if (hour >= 5 && hour < 7) return 3;   // Mão (5-7)
    if (hour >= 7 && hour < 9) return 4;   // Thìn (7-9)
    if (hour >= 9 && hour < 11) return 5;  // Tỵ (9-11)
    if (hour >= 11 && hour < 13) return 6; // Ngọ (11-13)
    if (hour >= 13 && hour < 15) return 7; // Mùi (13-15)
    if (hour >= 15 && hour < 17) return 8; // Thân (15-17)
    if (hour >= 17 && hour < 19) return 9; // Dậu (17-19)
    if (hour >= 19 && hour < 21) return 10;// Tuất (19-21)
    return 11; // Hợi (21-23)
}

/* Lấy tiết khí */
function getTietKhi(dd, mm, yy) {
    var jd = jdFromDate(dd, mm, yy);
    var sunLong = getSunLongitude(jd, 7);
    var tietKhiNames = [
        "Xuân phân", "Thanh minh", "Cốc vũ", "Lập hạ", "Tiểu mãn", "Mang chủng",
        "Hạ chí", "Tiểu thử", "Đại thử", "Lập thu", "Xử thử", "Bạch lộ",
        "Thu phân", "Hàn lộ", "Sương giáng", "Lập đông", "Tiểu tuyết", "Đại tuyết",
        "Đông chí", "Tiểu hàn", "Đại hàn", "Lập xuân", "Vũ thủy", "Kinh trập"
    ];
    return tietKhiNames[sunLong];
}

/* Định dạng giờ:phút:giây */
function formatTime(date) {
    return getTwoDigits(date.getHours()) + ':' + 
            getTwoDigits(date.getMinutes()) + ':' + 
            getTwoDigits(date.getSeconds());
}

/* Kiểm tra xem một ngày có phải là Dương Công Kỵ nhật không */
function isDuongCongKyNhat(lunarDay, lunarMonth) {
    var kyNhatList = [
        {month: 1, day: 13},
        {month: 2, day: 11},
        {month: 3, day: 9},
        {month: 4, day: 7},
        {month: 5, day: 5},
        {month: 6, day: 2},
        {month: 7, day: 1}, {month: 7, day: 29},
        {month: 8, day: 27},
        {month: 9, day: 25},
        {month: 10, day: 23},
        {month: 11, day: 21},
        {month: 12, day: 19}
    ];

    return kyNhatList.some(item => item.month === lunarMonth && item.day === lunarDay);
}

/* Xác định ngày sát sư theo tháng âm lịch */
function getSatSuDayChi(lunarMonth) {
    var dayChi;
    switch(lunarMonth) {
        case 1: dayChi = 0; break; // Tháng Giêng - Tý
        case 2: dayChi = 10; break; // Tháng 2 - Tuất
        case 3: dayChi = 11; break; // Tháng 3 - Hợi
        case 4: dayChi = 0; break; // Tháng 4 - Tý
        case 5: dayChi = 1; break; // Tháng 5 - Sửu
        case 6: dayChi = 2; break; // Tháng 6 - Dần
        case 7: dayChi = 3; break; // Tháng 7 - Mão
        case 8: dayChi = 4; break; // Tháng 8 - Thìn
        case 9: dayChi = 5; break; // Tháng 9 - Tỵ
        case 10: dayChi = 6; break; // Tháng 10 - Ngọ
        case 11: dayChi = 7; break; // Tháng 11 - Mùi
        case 12: dayChi = 8; break; // Tháng 12 - Thân
        default: dayChi = 0;
    }
    
    return dayChi;
}

/* Xác định giờ sát sư theo tháng âm lịch */
function getSatSuHourChi(lunarMonth) {
    var hourChi;
    switch(lunarMonth) {
        case 1: hourChi = 6; break; // Tháng Tý - giờ Ngọ
        case 2: hourChi = 11; break; // Tháng Sửu - giờ Hợi
        case 3: hourChi = 6; break; // Tháng Dần - giờ Ngọ
        case 4: hourChi = 5; break; // Tháng Mão - giờ Tỵ
        case 5: hourChi = 1; break; // Tháng Thìn - giờ Sửu
        case 6: hourChi = 7; break; // Tháng Tỵ - giờ Mùi
        case 7: hourChi = 8; break; // Tháng Ngọ - giờ Thân
        case 8: hourChi = 4; break; // Tháng Mùi - giờ Thìn
        case 9: hourChi = 11; break; // Tháng Thân - giờ Hợi
        case 10: hourChi = 6; break; // Tháng Dậu - giờ Ngọ
        case 11: hourChi = 6; break; // Tháng Tuất - giờ Ngọ
        case 12: hourChi = 3; break; // Tháng Hợi - giờ Mão
        default: hourChi = 0;
    }
    
    return hourChi;
}

/* Lấy thông tin Sát Sư của ngày và giờ hiện tại */
function getSatSuInfo(lunarDay, lunarMonth, lunarYear, currentHour) {
    var result = [];
    
    // Kiểm tra xem có phải là Dương Công Kỵ Nhật không
    if (isDuongCongKyNhat(lunarDay, lunarMonth)) {
        result.push("Dương Công Kỵ Nhật");
    }
    
    // Kiểm tra ngày sát sư
    var jd = jdFromDate(lunarDay, lunarMonth, lunarYear);
    var chiDay = (jd + 1) % 12;
    var satSuDayChi = getSatSuDayChi(lunarMonth);
    
    // Kiểm tra giờ sát sư
    var hourChi = getHourChi(currentHour);
    var satSuHourChi = getSatSuHourChi(lunarMonth);
    
    var isSatSuDay = false;
    var isSatSuHour = false;
    
    // Kiểm tra ngày dương lịch xem địa chi có trùng với ngày sát sư không
    var solarJd = jdFromDate(lunarDay, lunarMonth, lunarYear);
    var solarChiDay = (solarJd + 1) % 12;
    if (solarChiDay === satSuDayChi) {
        result.push("Ngày Sát Sư (" + CHI[satSuDayChi] + ")");
        isSatSuDay = true;
    }
    
    if (hourChi === satSuHourChi) {
        result.push("Giờ Sát Sư (" + CHI[satSuHourChi] + ": " + getHourRange(satSuHourChi) + ")");
        isSatSuHour = true;
    }
    
    if (!isSatSuDay && !isSatSuHour && result.length === 0) {
        return "Không phải ngày/giờ Sát Sư";
    }
    
    return result.join(", ");
}

/* Lấy khoảng giờ từ chi giờ */
function getHourRange(hourChi) {
    switch(hourChi) {
        case 0: return "23h-1h"; // Tý
        case 1: return "1h-3h"; // Sửu
        case 2: return "3h-5h"; // Dần
        case 3: return "5h-7h"; // Mão
        case 4: return "7h-9h"; // Thìn
        case 5: return "9h-11h"; // Tỵ
        case 6: return "11h-13h"; // Ngọ
        case 7: return "13h-15h"; // Mùi
        case 8: return "15h-17h"; // Thân
        case 9: return "17h-19h"; // Dậu
        case 10: return "19h-21h"; // Tuất
        case 11: return "21h-23h"; // Hợi
        default: return "";
    }
}

/* Kiểm tra một ngày có phải là ngày sát sư không */
function isSatSuDayInMonth(jd, lunarMonth) {
    var chiDay = (jd + 1) % 12;
    var satSuDayChi = getSatSuDayChi(lunarMonth);
    
    return chiDay === satSuDayChi;
}

/* Cập nhật hiển thị ngày hiện tại */
function updateCurrentDate(date) {
    if (!date) date = new Date();

    var dd = date.getDate();
    var mm = date.getMonth() + 1;
    var yy = date.getFullYear();
    var weekday = date.getDay();
    var hour = date.getHours();
    
    // Hiển thị ngày dương lịch
    document.getElementById('current-date').textContent = dd;
    document.getElementById('solar-month-year').textContent = "THÁNG " + mm + " NĂM " + yy;
    document.getElementById('weekday').textContent = TUAN[weekday].toUpperCase();
    
    // Cập nhật ngày âm lịch
    var lunar = convertSolar2Lunar(dd, mm, yy, 7);
    var lunarDay = lunar[0];
    var lunarMonth = lunar[1];
    var lunarYear = lunar[2];
    var lunarLeap = lunar[3];
    
    document.getElementById('lunar-day').textContent = lunarDay;
    document.getElementById('lunar-month').textContent = getLunarMonthName(lunarMonth) + (lunarLeap == 1 ? " (NHUẬN)" : "");
    
    // Can Chi năm
    var canYear = (lunarYear + 6) % 10;
    var chiYear = (lunarYear + 8) % 12;
    document.getElementById('lunar-year').textContent = "Năm " + CAN[canYear] + " " + CHI[chiYear];
    
    // Lấy Can Chi cho ngày, tháng, năm
    var canchi = getCanChi(dd, mm, yy);
    document.getElementById('can-chi-day').textContent = canchi.day;
    document.getElementById('can-chi-month').textContent = canchi.month;
    document.getElementById('can-chi-year').textContent = canchi.year;
    
    // Tiết khí
    document.getElementById('tiet-khi').textContent = getTietKhi(dd, mm, yy);
    
    // Cập nhật giờ hiện tại
    document.getElementById('current-time').textContent = formatTime(date);
    
    // Cập nhật thông tin Sát Sư
    var satSuInfo = getSatSuInfo(lunarDay, lunarMonth, lunarYear, hour);
    document.getElementById('sat-su-info').textContent = satSuInfo;
    
    // Cập nhật lịch tháng
    updateCalendarGrid(mm, yy);
}

/* Cập nhật lịch tháng */
function updateCalendarGrid(mm, yy) {
    var firstDay = new Date(yy, mm - 1, 1);
    var startingDay = firstDay.getDay();
    if (startingDay == 0) startingDay = 7; // Chuyển chủ nhật từ 0 thành 7
    startingDay--; // Đổi thành 0-6 với 0 là thứ 2
    
    var lastDay = new Date(yy, mm, 0);
    var monthLength = lastDay.getDate();
    
    var prevMonthLastDay = new Date(yy, mm - 1, 0).getDate();
    
    var html = '';
    var day = 1;
    var nextMonthDay = 1;
    
    for (var i = 0; i < 6; i++) {
        for (var j = 0; j < 7; j++) {
            if (i === 0 && j < startingDay) {
                // Ngày của tháng trước
                var prevDate = prevMonthLastDay - startingDay + j + 1;
                var prevMonth = mm - 1;
                var prevYear = yy;
                
                if (prevMonth === 0) {
                    prevMonth = 12;
                    prevYear = yy - 1;
                }
                
                var lunar = convertSolar2Lunar(prevDate, prevMonth, prevYear, 7);
                
                html += '<div class="calendar-day different-month">' +
                        '<div class="solar-day">' + prevDate + '</div>' +
                        '<div class="lunar-day-small">' + lunar[0] + '/' + lunar[1] + '</div>' +
                        '</div>';
            } else if (day <= monthLength) {
                // Ngày của tháng hiện tại
                var today = new Date();
                var isToday = day === today.getDate() && mm === today.getMonth() + 1 && yy === today.getFullYear();
                
                var lunar = convertSolar2Lunar(day, mm, yy, 7);
                var jd = jdFromDate(day, mm, yy);
                
                // Kiểm tra xem ngày này có phải ngày sát sư không
                var isSatSu = isSatSuDayInMonth(jd, lunar[1]);
                
                html += '<div class="calendar-day' + (isToday ? ' today' : '') + (isSatSu ? ' sat-su-day' : '') + '">' +
                        '<div class="solar-day">' + day + '</div>' +
                        '<div class="lunar-day-small">' + lunar[0] + '/' + lunar[1] + '</div>' +
                        '</div>';
                day++;
            } else {
                // Ngày của tháng sau
                var nextMonth = mm + 1;
                var nextYear = yy;
                
                if (nextMonth === 13) {
                    nextMonth = 1;
                    nextYear = yy + 1;
                }
                
                var lunar = convertSolar2Lunar(nextMonthDay, nextMonth, nextYear, 7);
                
                html += '<div class="calendar-day different-month">' +
                        '<div class="solar-day">' + nextMonthDay + '</div>' +
                        '<div class="lunar-day-small">' + lunar[0] + '/' + lunar[1] + '</div>' +
                        '</div>';
                nextMonthDay++;
            }
        }
    }
    
    document.getElementById('calendar-days').innerHTML = html;
    document.getElementById('month-title').textContent = "LỊCH ÂM THÁNG " + mm + "/" + yy;
}
